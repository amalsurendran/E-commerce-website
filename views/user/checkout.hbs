<br><br><br><br>
<section class="h-100 h-custom" style="background-color: #ffffff;">
  <div class="container py-5 h-100">
    <div class="row d-flex justify-content-center align-items-center h-100">
      <div class="col-12">
        <br><br><br>
        <div class="card card-registration card-registration-2" style="border-radius: 15px;">
          <div class="card-body p-0">
            <div class="row g-0">
              <div class="col-lg-12">
                <div class="p-5">
        <div class="container">
            <div class="row billing-fields">
                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                    <div class="create-ac-content bg-light-gray padding-20px-all">
                        <br><br>
                        <h2>Deliver to:</h2>
                        <br>
                        <div class="row">
                            <select class="form-select form-select-lg mb-3" id="addressform" onchange="addressValue()">
                                {{#each address}}
                                <option {{_id}}>
                                    <div class="col-md-6">
                                        <div class="bg-white card addresses-item mb-4 border border-primary shadow">
                                            <div class="gold-members p-4">
                                                <div class="media">
                                                    <div class="mr-3"><i class="icofont-ui-home icofont-3x"></i>
                                                    </div>
                                                    <div class="media-body">
                                                        <h6>{{deliver_to}}</h6>&nbsp
                                                        <p>{{name}} &nbsp
                                                            &nbsp<b>{{number}}</b>
                                                        </p>
                                                        <p>{{house}}</p>
                                                        <p>{{city}}, {{state}}, {{country}}</p>
                                                        <p>{{address}} - {{pincode}} </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </option>
                                {{/each}}
                            </select>

                           
                            <br>
                            <div class="d-flex justify-content-left mb-2">
                                <a href="/checkoutAddress" class="btn btn-outline-dark"><strong>Add new
                                        Address</strong></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                    <div class="your-order-payment">
                        <div class="your-order">
                            <h2 class="order-title mb-4">Your Order</h2>

                            <div class="table-responsive-sm order-table table-bordered">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Product Name</th>
                                            <th scope="col">Quantiy</th>
                                            <th scope="col">Price</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each productDetails}}
                                        <tr>
                                            <td scope="row">{{this.name}}</td>
                                            <td>{{this.quantity}}</td>
                                            <td>{{this.price}}</td>
                                            <input type="hidden" name="productid" value="{{this._id}}">
                                            <input type="hidden" name="productname" value="{{this.name}}">
                                            <input type="hidden" name="price" value="{{this.price}}">
                                            <input type="hidden" name="quantity" value="{{this.quantity}}">
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td>Total</td>
                                            <td></td>
                                            <td>{{subtotal}}</td>
                                             <input type="hidden" id="subtotal" value="{{subtotal}}">
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <hr>
                        <div class="your-payment">
                            <h2 class="payment-title mb-3">Payment Method</h2>
                            <br>
                            <div class="payment-method">
                                <div class="form-check">
                                    <input onclick="enableButton()" class="form-check-input" type="radio" name="payment"
                                        id="COD" value="1">
                                    <label class="form-check-label" for="payment1">
                                        Cash On Delivery
                                    </label>
                                    <div>
                                        <input onclick="enableButton()" class="form-check-input" type="radio"
                                            name="payment"id="rzp-button1" value="2">
                                        <label class="form-check-label" for="payment2">
                                            RazorPay
                                        </label>
                                    </div>
                                </div>
                                <hr>
                                <div class="order-button-payment">
                                    <button class="btn" onclick="CheckplaceOrder()" value="Place order" id="placeOrderButton"
                                        disabled>Place
                                        order</button>
                                </div>
                                <input type="hidden" name="radioValue">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>
              </div></div></div></div></div></div></div></section>

</body>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

  let payment;
    let subtotal;
 subtotal = Number(document.getElementById('subtotal').value)
 let total = subtotal*100;
    async function enableButton() {
            
        document.getElementById('placeOrderButton').disabled = false
console.log(subtotal)
    }
  
 
 async  function   CheckplaceOrder(){
       payment=  Object.values(document.getElementsByName('payment')).filter((item) => item.checked ? item : '').map((item) => item.value)
    if(payment[0]==='1'){
        placeOrder();
    }else{
        
 var orderId;
  subtotal = total
  $(document).ready(function () {
    
    var settings = {
      url: "/create/orderId",
      method: "POST",
      timeout: 0,
      headers: {
        "Content-Type": "application/json",
      },
      data: JSON.stringify({
        amount:subtotal, //CHANGE THE AMOUNT AS NEEDED
      }),
    };

    //creates new orderId everytime
    $.ajax(settings).done(function (response) {
      orderId = response.orderId;
      console.log(orderId);
    });
  });

  document.getElementById("placeOrderButton").onclick = function (e) {
    var options = {
      key: "rzp_test_LPJeP3o1ny1FXv", // Enter the Key ID generated from the Dashboard
      amount:subtotal, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      currency: "INR",
      name: "LensFocus",
      description: "Test Transaction",
      image: "https://example.com/your_logo",
      order_id: orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      handler: function (response) {
        alert(response.razorpay_payment_id);
        alert(response.razorpay_order_id);
        alert(response.razorpay_signature);
        var settings = {
          url: "/api/payment/verify",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json",
          },
          data: JSON.stringify({ response }),
        };
console.log(response)
        $.ajax(settings).done(function (response) {
           placeOrder();
          alert(JSON.stringify(response));
        });
      },

      theme: {
        color: "#0000FF",
      },
    };
    var rzp1 = new Razorpay(options);
    rzp1.on("payment.failed", function (response) {
      alert(response.error.code);
      alert(response.error.description);
      alert(response.error.source);
      alert(response.error.step);
      alert(response.error.reason);
      alert(response.error.metadata.order_id);
      alert(response.error.metadata.payment_id);
    });
    rzp1.open();
    e.preventDefault();
  };


    }
  }



    async  function placeOrder() {
        const productid = Object.values(document.getElementsByName('productid')).map((item) => item.value)
        const productname = Object.values(document.getElementsByName('productname')).map((item) => item.value)
        const price = Object.values(document.getElementsByName('price')).map((item) => item.value)
        const quantity = Object.values(document.getElementsByName('quantity')).map((item) => item.value)
        const addressId = document.getElementById('addressform').value
         
       
        let data = {
            productid: productid,
            productname: productname,
            price: price,
            quantity: quantity,
            addressId: addressId,
            payment: payment,
            subtotal: subtotal
   
        }
      
         
         try {
            let orderplacement = await fetch('/place-order',  {
                method: 'post',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            let res = await orderplacement.json()
           
            if (res.res == "success") { 
                Swal.fire({
                    title: 'Success',
                    text: "Item ordered successfully !",
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'OK',
                    timer: 3000
                }).then((res) => {
                    window.location.href = '/success'
                })
            } else {
                Swal.fire({
                 
                title: 'Something went wrong',
                text: "something went wrong !",

                icon: 'failure',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'OK',
                timer: 3000
            }).then((res) => {
                window.location.href = '/home'
            })
            }
        } catch (error) {
            console.log(error)
        }
     
       

    }

 

</script>

